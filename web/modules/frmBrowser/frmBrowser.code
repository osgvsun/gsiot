var self = this;Form.call(this, name);this.app = app; this.parent = app.parent;this.Timer = null;
this.data=null;this.tmpldata=null;this.tmpldata=null;
this.load = function () {
    self = this.app.Forms[this.Name];
    this.tmpl = this.app.path + "/frmBrowser/frmBrowser.txt";
    this.PublicServation = this.app.station.PublicServation;
    this.dataurl = this.app.rootpath + this.app.api.showlibrary;
    if (this.PublicServation) {
        file = new JsonFile(this.app.rootpath + this.app.api.share_record)
        var now = new Date().Format("yyyy-MM-dd hh:mm:ss")
        if (file.isEmpty || file.data.InspectionRecord[0].datetime.endtime < now) {
            console.log(this.app.api.makeshare.LoadJson());
            file.Readfile();
        }
    }
};
this.Show=function(){
    console.log("wsc_receive:" + this.Name);this.app.Forms.activeForm = this;
    if(this.isload==false){this.load();this.isload=true;}
    if(this.tmpl!=null){
        if(this.tmpldata==null)this.tmpldata=this.tmpl.LoadURL();
        if(this.data==null && this.dataurl!=null)this.data=this.dataurl.LoadJson();
        if(this.data==null)this.data=this;
        else{data=[];this.data.result.ForEach(function(item,index){if(item.InspectionRecord.length!=0)data.Add(item);});this.data.result=data;};
        this.parent.Tmpl(this.tmpldata,this.data);
    }
    if (this.Timer==null) {this.Timer=setInterval(this.task,60000);};
};
this.Form_Resize = function (w, h) { };
this.Form_Receive = function (data) {
    console.log(this.Name + " receive:" + JSON.stringify(data))
    if (data.cmd == "show library id") {this.data=this.dataurl.LoadJson();this.Show();
    } else if (data.type == "event_auth") {
        if (data.code = 200) {
            this.app.cfg.policy.username = data.data.username;
            this.app.cfg.policy.cname = data.data.cname;
        }
    }
};
this.task=function(){
    var flag=false;
    if(self.data!=null){
        self.data.result.ForEach(
            function(item,index){if(item!=null){
                item.InspectionRecord.ForEach(
                    function(record){
                        record.datetime.now=new Date().Format("yyyy-MM-dd hh:mm:ss");
                        if(record.datetime.endtime<record.datetime.now) flag=true;
                    })};return !flag;})};
    if(self.app.Forms.activeForm.Name==self.Name){
        if(flag){console.log("刷新页面："+new Date().Format("hh:mm:ss"));self.data=null;self.Show();}
    }else if(self.Timer!=null){window.clearInterval(self.Timer);self.Timer=null;}

};
this.cmdInspection_Click = function (CourseID, ExperimentID, starttime, endtime) {
    if (CourseID == null || CourseID == "share") {
        file = new JsonFile(this.app.rootpath + this.app.api.share_record)
        with (this.app.policy) { courseid = "share"; experimentid = "01"; InspectionRecord = file.data.InspectionRecord[0] }
        if(this.app.Forms.frmInspection!=null)this.app.Forms.frmInspection.Show();
    } else {
        console.log("policy:" + JSON.stringify(self.app.policy))
        var now = new Date().Format("yyyy-MM-dd hh:mm:ss")
        if (starttime < now && now < endtime) {
            if (this.app.policy.username == "") {
                with (this.app.policy) { courseid = CourseID; experimentid = ExperimentID; start = starttime; end = endtime }
                if(this.app.Forms.frmLogin!=null)this.app.Forms.frmLogin.Show();
            } else this.CheckPolicy();
        } else if (starttime > now) {
            msgbox("预约时间为\n" + starttime + "\n至\n" + endtime + "\n,该预约没有开始", 3)
        } else if (endtime < now) {
            msgbox("预约时间为\n" + starttime + "\n至\n" + endtime + "\n,预约已结束", 3)
        }
    }
};
this.CheckPolicy = function () {
    var start = this.app.cfg.policy.start,
        end = this.app.cfg.policy.end,
        devindex = this.app.cfg.release.device.id + "_"
            + this.app.cfg.policy.courseid + "_"
            + this.app.cfg.policy.experimentid;
    console.log("starttime:" + start)
    console.log("endtime:" + end)
    console.log("CourseID:" + this.app.cfg.policy.courseid)
    console.log("ExperimentID:" + this.app.cfg.policy.experimentid)
    console.log("devindex:" + devindex)

    this.app.cfg.policy.data.ForEach(function (policy, index) {
        if (policy.devindex == App.data.cfg.release.device.id || policy.devindex == devindex) {
            url = App.rootpath + "/api/showlibraryid/<username>/<course>/<experiment>"
                .replace("<username>", this.app.cfg.policy.username)
                .replace("<course>", this.app.cfg.policy.courseid)
                .replace("<experiment>", this.app.cfg.policy.experimentid)
            result = url.LoadJson();
            // App.frmWork.binddata = {"data":result}
            App.frmWork.Show();
        } else { console.log(policy.devindex); }
    })
};